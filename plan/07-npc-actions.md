# Plan 07 — NPC Actions, Reactions, Legendary Actions & Spells

**Goal:** Extend the NPC generation pipeline (waves 6–9) to produce embedded items — attacks, special abilities, reactions, legendary actions, and spells — on top of the stat block generated by waves 1–5.

---

## Context

Waves 1–5 produce **actor update fields** (ability scores, HP, AC, etc.) applied via `document.update()`. NPC actions are fundamentally different: they are **embedded Item documents** created via `actor.createEmbeddedDocuments("Item", [...])`. This plan adds the infrastructure to support both result types in the pipeline, then adds four new wave groups.

Spells use **compendium lookup** — the LLM suggests spell names, code finds them in the `dnd5e.spells` compendium and copies them as embedded items.

---

## 1. Embedded Item Infrastructure

**Files:** `scripts/ItemGeneratorApp.js`, `scripts/npc-groups.js`

### Convention

`mapResult()` can return an `_embedded` key containing item creation data:

```js
{
  system: { ... },                    // actor update (existing)
  _embedded: { Item: [ ... ] },       // embedded item creates (new)
}
```

### Changes to `ItemGeneratorApp.js`

- Add `this.lastEmbeddedItems = []` in constructor
- Add `_extractEmbedded(mapped)` helper — splits `_embedded.Item` from actor update data
- In `_generate()`: after each `mapResult`, extract embedded items into a running list, merge the rest as before
- `await` all `mapResult()` calls (harmless on sync returns, needed for spells)
- In `_onApply()`:
  - Call `document.update(lastResult)` for actor fields (existing)
  - Delete existing items flagged `flags.simsala.generated = true`
  - Call `document.createEmbeddedDocuments("Item", flaggedItems)` for new items
- Pass embedded item summaries (names/types) in `prior` context for later wave prompts
- Update follow-up context in `_onSend()` to include embedded item names

### Chat display

Show embedded items as a readable list below the actor JSON, not raw item data dumps.

---

## 2. Wave 6 — Passive Abilities

**Group:** `passiveAbilities`

Traits like Magic Resistance, Keen Senses, Pack Tactics, Spider Climb, Amphibious. Simplest embedded item type — feats with no activities.

**LLM outputs:**
```json
{ "abilities": [{ "name": "Magic Resistance", "description": "..." }] }
```

**mapResult** → `_embedded.Item` array of feat items:
```js
{ type: "feat", name, system: { type: { value: "monster" }, description: { value: `<p>...</p>` } } }
```

**Prompt includes:** common passive abilities by creature type, limit 0–4 based on CR.

---

## 3. Wave 7 — Attacks

**Group:** `attacks`

Weapon attacks (Bite, Claw, Greataxe, etc.) as embedded weapon items. The dnd5e system auto-creates attack activities on weapon `_preCreate`, so we don't build activities manually.

**LLM outputs:**
```json
{
  "hasMultiattack": true,
  "multiattackDescription": "The dragon makes three attacks: one with its bite and two with its claws.",
  "attacks": [{
    "name": "Bite", "attackType": "melee", "reach": 10,
    "damageFormula": "2d10+6", "damageType": "piercing",
    "extraDamageFormula": "1d10", "extraDamageType": "fire",
    "description": ""
  }]
}
```

**mapResult** → embedded items:
- Multiattack as a description-only feat (if `hasMultiattack`)
- Each attack as a weapon item (`system.type.value = "natural"`)
- Extra damage (e.g. "plus 2d6 fire") included in the weapon description text (simplest approach — avoids manually modifying auto-created activities)

**Prompt includes:** CR-appropriate damage benchmarks (CR 1: 1d8+2, CR 5: 2d8+4, CR 10: 2d10+5, etc.)

---

## 4. Wave 8 — Actions, Reactions & Legendary Actions

**Group:** `actionsReactions`

Special abilities (Breath Weapon, Frightful Presence), reactions (Parry, Shield), and legendary actions. All become feat items with manually constructed activities.

**LLM outputs:**
```json
{
  "legendaryActionCount": 3,
  "legendaryResistanceCount": 3,
  "actions": [{
    "name": "Fire Breath", "activationType": "action",
    "description": "...", "recharge": "5-6",
    "saveDC": 18, "saveAbility": "dex",
    "damageFormula": "16d6", "damageType": "fire",
    "legendaryActionCost": 0
  }]
}
```

**mapResult** returns both:
- **Actor update:** `system.resources.legact.max`, `system.resources.legres.max`
- **Embedded items:** feat items with activities built by a `buildFeatItem()` helper:
  - Save + damage → `type: "save"` activity with `dc.formula` and damage parts
  - Damage only → `type: "damage"` activity
  - No mechanics → `type: "utility"` activity (just tracks activation type)
  - Recharge → `system.uses` with `recovery: [{ period: "recharge", formula }]`
  - Legendary cost → `activation.value` on the activity

**Prompt includes:** examples by creature archetype (dragons: breath weapon + frightful presence, liches: legendary actions, warriors: parry reaction).

---

## 5. Wave 9 — Spells

**Group:** `spells`

The LLM picks spell names; code looks them up in `dnd5e.spells` compendium. `mapResult` is **async**.

**LLM outputs:**
```json
{
  "spellcastingAbility": "int",
  "spellcastingLevel": 9,
  "atWillSpells": ["mage hand", "fire bolt"],
  "innateSpells": ["counterspell", "shield"],
  "preparedSpells": ["fireball", "hold person", "magic missile"]
}
```

**mapResult:**
- Look up each spell name in `game.packs.get("dnd5e.spells")` (case-insensitive)
- Set `system.preparation.mode` to `"atwill"`, `"innate"`, or `"prepared"` accordingly
- Log warnings for spells not found (LLM may hallucinate names)
- Return actor update: `system.attributes.spellcasting` and `system.attributes.spell.level`
- Return `_embedded.Item` with looked-up spell documents

**New file:** `scripts/compendium-utils.js` — exports `lookupSpells(names)` utility.

**Prompt includes:** curated list of common spell names by level to reduce hallucination.

---

## 6. Updated Wave Pipeline

```js
export const NPC_WAVES = [
  ["concept"],                              // Wave 1
  ["mechanical"],                           // Wave 2
  ["coreStats"],                            // Wave 3
  ["savesSkills", "sensesLanguages"],        // Wave 4 (parallel)
  ["description"],                          // Wave 5
  ["passiveAbilities", "attacks"],           // Wave 6 (parallel — independent of each other)
  ["actionsReactions"],                      // Wave 7 (needs attack names for context)
  ["spells"],                               // Wave 8 (needs full picture for spell selection)
];
```

Passive abilities and attacks run in parallel (wave 6) since they're independent. Actions/reactions come after attacks so the LLM can reference them (e.g. "The dragon makes a tail attack as a legendary action"). Spells last since they're optional and need full context.

---

## 7. Implementation Steps

1. **Embedded item infrastructure** in `ItemGeneratorApp.js` — `_extractEmbedded`, updated `_generate`, updated `_onApply`, updated `_onSend` context
2. **`passiveAbilities` group** in `npc-groups.js` — simplest test of the pipeline
3. **`attacks` group** in `npc-groups.js` — weapon items with multiattack
4. **`actionsReactions` group** in `npc-groups.js` — feats with activities, `buildFeatItem` helper
5. **`compendium-utils.js`** + **`spells` group** in `npc-groups.js` — async compendium lookup
6. **Follow-up context** — update `_onSend` to include embedded item names in refinement prompt

---

## 8. Verification

- Generate a dragon-type NPC → expect: multiattack, bite/claw/tail attacks, breath weapon with save DC, frightful presence, legendary actions (3), legendary resistances (3), passive abilities (e.g. Legendary Resistance description feat)
- Generate a spellcaster NPC → expect: spells from compendium on the sheet, spellcasting ability set
- Generate a simple beast → expect: 1-2 attacks, maybe a passive ability, no spells, no legendary actions
- Re-apply after refinement → expect: old simsala-flagged items deleted, new ones created
- Check that waves 1–5 still work identically (no `_embedded` returned, no behavior change)
