# Plan 06 — MVP 2

**Goal:** Add NPC generation, improve item generation quality, and make the tool more reliable and approachable through better UX and error handling.

See `plan/foundry_mvpv2_discussion.md` for the extended architectural notes this plan was consolidated from.

---

## 1. Ollama Health & Model UX

The most common user failure is "nothing happened" — Ollama isn't running or the model wasn't pulled. This should surface clearly before the user wastes time.

### Connection indicator
- Status badge in the Simsala window header: **Connected** / **Disconnected** / **Checking…**
- Checks `GET /api/version` on window open and after any failed generation
- No polling during idle

### Model selector
- Replace the free-text model name setting with a dropdown populated from `GET /api/tags`
- Shows only models the user has actually pulled locally
- Falls back to free-text input if Ollama is unreachable

### Setup guidance
- When Ollama is unreachable, show a short in-window message with fix steps instead of a raw error string
- When the selected model is missing from the available list, warn before sending

---

## 2. NPC Generation

NPCs are Actor documents (type `npc`). Same multi-prompt pattern as items, targeting the dnd5e actor schema.

### Scope for MVP 2: core stat block, no actions

Actions, reactions, legendary actions, and spells are complex and have their own data source dependencies. Deferred to MVP 3.

### Entry point
- Button injected into NPC actor sheet header via the equivalent render hook (`renderActorSheet5eNPC`)
- Opens `NpcGeneratorApp` — shares the chat window base with `ItemGeneratorApp`

### Wave pipeline

**Wave 1 — Concept & Flavor**
Name, creature type, role (bruiser, controller, skirmisher, support), CR target, personality traits, thematic keywords (e.g. "shadow", "fire", "undead corruption"). Almost entirely creative — forms the brief for all subsequent waves.

**Wave 2 — Mechanical Identity**
Size, alignment, damage immunities/resistances/vulnerabilities, condition immunities, movement types. Translates flavor into mechanical profile without touching numbers. Informed directly by Wave 1 keywords.

**Wave 3 — Core Stats**
Ability scores, AC, HP formula, speed. Constrained by CR target and mechanical identity from Waves 1–2. First CR sanity check runs here using the CR Calculator (see section 4) — result surfaced to GM as informational, not blocking.

**Wave 4 — Derived Stats**
Saving throw proficiencies, skill proficiencies, passive perception, senses, languages. Generated in parallel where fields are independent.

**Wave 5 — CR Validation**
Full DMG CR formula runs against the complete stat block. If calculated CR diverges from the Wave 1 target by more than one tier, the delta is fed back to the LLM as a targeted correction (most impactful lever: HP, AC, or implied DPR). GM sees both target and calculated CR throughout.

**Wave 6 — Approval**
Full stat block previewed in chat. GM iterates via conversation if needed. Apply populates the actor sheet.

---

## 3. CR Calculator

A self-contained implementation of the DMG CR formula. Deterministic, no LLM involvement. Runs client-side.

**Inputs:** HP, AC, resistances/immunities (as HP multiplier), damage per round, attack bonus or save DC

**Process:**
1. Effective HP = raw HP adjusted for resistances/immunities
2. Defensive CR from HP table, adjusted for AC deviation from expected
3. Offensive CR from DPR table, adjusted for attack bonus/save DC deviation
4. Average defensive and offensive CR

**Output shown to GM:** calculated CR + per-component breakdown so they understand what's driving it and can make targeted adjustments through conversation.

---

## 4. UX Improvements

### Diff view on follow-up turns
On the second+ generation turn, highlight what changed between `lastResult` and the new result. Simple key-level comparison — changed values marked with a subtle indicator. Helps the GM see what the model actually updated.

### Apply warning for existing data
If the entity already has non-empty fields, warn before overwriting: *"This will overwrite existing data. Continue?"* Suppressible per session.

### Copy individual fields
Add copy buttons on individual key/value pairs for quick partial use alongside the existing full-JSON copy.

---

## 5. Error Handling

| Scenario | Behavior |
|---|---|
| Ollama not running | Clear in-chat message: "Could not connect to Ollama at localhost:11434. Make sure Ollama is running." |
| Model not found | Error with hint to run `ollama pull <model>` |
| Invalid JSON returned | Structured error fed back to model, one retry |
| Second consecutive failure | Raw output shown in chat with warning — GM can proceed manually |
| Missing fields | Valid fields accepted, missing fields left as Foundry defaults, noted in chat |
| CR discrepancy > 1 tier | Delta fed back to LLM as targeted correction prompt |
| Network timeout | Error in chat, generation state reset to idle |

---

## 6. Scope Boundaries

**In MVP 2:**
- Ollama health check + model selector dropdown
- Item wave refinement (description after mechanics)
- NPC core stat block (waves 1–5, no actions/spells)
- CR Calculator
- Diff view, apply warning, copy individual fields
- Improved error messages

**Deferred to MVP 3:**
- NPC actions, reactions, legendary actions, spells
- Data source system (compendium pool for spells and monster abilities — needed to support NPC spell selection)
- Reflavoring system (mechanical template vs flavored presentation)
- Community contribution pathway for data sources

---

## 7. Pre-Implementation Tasks

1. Extract and document the dnd5e Actor schema for NPCs (same approach as items — read from `/home/vibo/workspace/dnd5e`)
2. Prototype NPC wave prompts manually in Ollama before wiring into the module
3. Implement and test the DMG CR formula against known monster stat blocks
4. Identify the render hook name for NPC actor sheets in Foundry v13
