# Plan 06 — MVP 2

**Goal:** Add NPC generation, improve item generation quality, and make the tool more reliable and approachable through better UX and error handling.

See `plan/foundry_mvpv2_discussion.md` for the extended architectural notes this plan was consolidated from.

---

## 1. Ollama Health & Model UX

The most common user failure is "nothing happened" — Ollama isn't running or the model wasn't pulled. This should surface clearly before the user wastes time.

### Connection indicator
- Status badge in the Simsala window header: **Connected** / **Disconnected** / **Checking…**
- Checks `GET /api/version` on window open and after any failed generation
- No polling during idle

### Model selector
- Replace the free-text model name setting with a dropdown populated from `GET /api/tags`
- Shows only models the user has actually pulled locally
- Falls back to free-text input if Ollama is unreachable

### Setup guidance
- When Ollama is unreachable, show a short in-window message with fix steps instead of a raw error string
- When the selected model is missing from the available list, warn before sending

---

## 2. NPC Generation

NPCs are Actor documents (type `npc`). Generation follows a sequential wave pipeline where each wave receives all prior output as context. This is different from items (two waves) because NPC fields form a deep dependency chain — you can't choose a size without knowing the creature type, can't set HP without knowing size and CR, can't pick skills without knowing ability scores.

### Scope for MVP 2: core stat block, no actions

Actions, reactions, legendary actions, and spells are deferred to MVP 3.

### Code reuse

Extract shared chat window logic from `ItemGeneratorApp` into a base `GeneratorApp` class. Both `ItemGeneratorApp` and `NpcGeneratorApp` extend it. The base class owns: chat history rendering, `_appendMessage()`, `_setStatus()`, `_onSend()`, and `_onApply()`. Subclasses provide the entity document, the wave definition, and entity-specific validation.

### Entry point
- Button injected into NPC actor sheet header via `renderNPCActorSheet` hook (same DOM injection as items)
- Opens `NpcGeneratorApp`

### Wave pipeline

Each wave is a single LLM call. Every wave receives all prior wave output as context.

```
Wave 1          Wave 2              Wave 3           Wave 4                   Wave 5         CR check
Concept    →    Mechanical      →   Core Stats   →   Saves / Skills /     →   Description →  (deterministic,
& Flavor        Identity                              Senses / Languages                      no LLM)
                                                      (parallel groups)
```

**Wave 1 — Concept & Flavor** · depends on: GM prompt only

| Field path | Description | Values |
|---|---|---|
| `name` | NPC name | string |
| `system.details.cr` | Challenge Rating target | number 0–30 |
| `system.details.type.value` | Creature type | `aberration` `beast` `celestial` `construct` `dragon` `elemental` `fey` `fiend` `giant` `humanoid` `monstrosity` `ooze` `plant` `undead` |
| `system.details.type.subtype` | Subtype | string, e.g. "shapechanger", "goblinoid" |

**Wave 2 — Mechanical Identity** · depends on: Wave 1 (creature type, CR)

Translates the creative concept into a mechanical framework — no numbers yet except movement speeds.

| Field path | Description | Values |
|---|---|---|
| `system.traits.size` | Size | `tiny` `sm` `med` `lg` `huge` `grg` |
| `system.traits.di.value` | Damage immunities | array of: `acid` `bludgeoning` `cold` `fire` `force` `lightning` `necrotic` `piercing` `poison` `psychic` `radiant` `slashing` `thunder` |
| `system.traits.dr.value` | Damage resistances | same damage type keys |
| `system.traits.ci.value` | Condition immunities | array of: `blinded` `charmed` `deafened` `exhaustion` `frightened` `grappled` `incapacitated` `invisible` `paralyzed` `petrified` `poisoned` `prone` `restrained` `stunned` `unconscious` |
| `system.attributes.movement.walk` | Walk speed (ft) | number |
| `system.attributes.movement.fly` | Fly speed (ft) | 0 if none |
| `system.attributes.movement.swim` | Swim speed (ft) | 0 if none |
| `system.attributes.movement.burrow` | Burrow speed (ft) | 0 if none |
| `system.attributes.movement.climb` | Climb speed (ft) | 0 if none |

**Wave 3 — Core Stats** · depends on: Waves 1–2 (CR for benchmarks, size for hit die)

Hit die by size: tiny=d4, sm=d6, med=d8, lg=d10, huge=d12, grg=d20 — include in prompt.

| Field path | Description | Notes |
|---|---|---|
| `system.abilities.str.value` | Strength | |
| `system.abilities.dex.value` | Dexterity | |
| `system.abilities.con.value` | Constitution | |
| `system.abilities.int.value` | Intelligence | |
| `system.abilities.wis.value` | Wisdom | |
| `system.abilities.cha.value` | Charisma | |
| `system.attributes.ac.flat` | Armor Class | |
| `system.attributes.ac.calc` | AC calc mode | Fixed `"natural"` — not from LLM |
| `system.attributes.hp.max` | Max HP | Should equal average of formula |
| `system.attributes.hp.formula` | HP formula | e.g. `"8d8+16"` |

**Wave 4 — Derived Stats** · depends on: Waves 1–3 (ability scores, CR, creature type)

These groups are independent of each other and can run in parallel.

*Group: Saves & Skills*

| Field path | Description | Values |
|---|---|---|
| `system.abilities.[str\|dex\|con\|int\|wis\|cha].proficient` | Save proficiency | 0 or 1 |
| `system.skills.[key].value` | Skill proficiency | 0=none, 1=proficient, 2=expertise |

Skill keys: `acr` (Acrobatics) `ani` (Animal Handling) `arc` (Arcana) `ath` (Athletics) `dec` (Deception) `his` (History) `ins` (Insight) `itm` (Intimidation) `inv` (Investigation) `med` (Medicine) `nat` (Nature) `prc` (Perception) `prf` (Performance) `per` (Persuasion) `rel` (Religion) `slt` (Sleight of Hand) `ste` (Stealth) `sur` (Survival)

*Group: Senses & Languages*

| Field path | Description | Values |
|---|---|---|
| `system.attributes.senses.darkvision` | Darkvision (ft) | 0 if none |
| `system.attributes.senses.blindsight` | Blindsight (ft) | 0 if none |
| `system.attributes.senses.tremorsense` | Tremorsense (ft) | 0 if none |
| `system.attributes.senses.truesight` | Truesight (ft) | 0 if none |
| `system.traits.languages.value` | Languages | Standard: `common` `draconic` `dwarvish` `elvish` `giant` `gnomish` `goblin` `halfling` `orc`. Exotic: `abyssal` `celestial` `deep` `infernal` `primordial` `sylvan` `undercommon` `gith` `gnoll` `aarakocra` |
| `system.traits.languages.custom` | Custom languages | semicolon-separated string |

**Wave 5 — Description** · depends on: Waves 1–4 (needs full picture for rich biography)

| Field path | Description |
|---|---|
| `system.details.biography.value` | Appearance, personality, lore — HTML wrapped in `<p>` tags |

**Post-generation — CR Validation** · deterministic, no LLM

Run the CR Calculator (section 3) against the full stat block. Show calculated CR alongside target CR. If discrepancy exceeds 1 tier, surface a note in chat — the GM can follow up conversationally to adjust.

---

## 3. CR Calculator

A self-contained implementation of the DMG CR formula. Deterministic, no LLM involvement. Runs client-side.

**Inputs:** HP, AC, resistances/immunities (as HP multiplier), damage per round, attack bonus or save DC

**Process:**
1. Effective HP = raw HP adjusted for resistances/immunities
2. Defensive CR from HP table, adjusted for AC deviation from expected
3. Offensive CR from DPR table, adjusted for attack bonus/save DC deviation
4. Average defensive and offensive CR

**Output shown to GM:** calculated CR + per-component breakdown so they understand what's driving it and can make targeted adjustments through conversation.

---

## 4. UX Improvements

### Diff view on follow-up turns
On the second+ generation turn, highlight what changed between `lastResult` and the new result. Simple key-level comparison — changed values marked with a subtle indicator. Helps the GM see what the model actually updated.

### Apply warning for existing data
If the entity already has non-empty fields, warn before overwriting: *"This will overwrite existing data. Continue?"* Suppressible per session.

### Copy individual fields
Add copy buttons on individual key/value pairs for quick partial use alongside the existing full-JSON copy.

---

## 5. Error Handling

| Scenario | Behavior |
|---|---|
| Ollama not running | Clear in-chat message: "Could not connect to Ollama at localhost:11434. Make sure Ollama is running." |
| Model not found | Error with hint to run `ollama pull <model>` |
| Invalid JSON returned | Structured error fed back to model, one retry |
| Second consecutive failure | Raw output shown in chat with warning — GM can proceed manually |
| Missing fields | Valid fields accepted, missing fields left as Foundry defaults, noted in chat |
| CR discrepancy > 1 tier | Delta fed back to LLM as targeted correction prompt |
| Network timeout | Error in chat, generation state reset to idle |

---

## 6. Scope Boundaries

**In MVP 2:**
- Ollama health check + model selector dropdown
- NPC core stat block (identity + parallel detail groups, no actions/spells)
- CR Calculator
- Diff view, apply warning, copy individual fields
- Improved error messages

**Deferred to MVP 3:**
- NPC actions, reactions, legendary actions, spells
- Data source system (compendium pool for spells and monster abilities — needed to support NPC spell selection)
- Reflavoring system (mechanical template vs flavored presentation)
- Community contribution pathway for data sources

---


## 7. Pre-Implementation Tasks

1. Extract and document the dnd5e Actor schema for NPCs (same approach as items — read from `/home/vibo/workspace/dnd5e`)
2. Prototype NPC wave prompts manually in Ollama before wiring into the module
3. Implement and test the DMG CR formula against known monster stat blocks
4. Identify the render hook name for NPC actor sheets in Foundry v13
